<html><head><base href="https://radiologos-info.com/tac-helper/">
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Asistente de Informes TAC para Radiólogos con Vista Previa y Texto Libre</title>
<style>
  body {
    font-family: Arial, sans-serif;
    line-height: 1.6;
    color: #333;
    margin: 0;
    padding: 0;
    background-color: #f0f0f0;
    display: flex;
    flex-direction: column;
    min-height: 100vh;
  }
  .main-container {
    flex: 1;
    display: flex;
    padding: 20px;
  }
  .content-container {
    flex: 3;
    max-width: 75%;
  }
  .preview-container {
    flex: 1;
    background-color: #fff;
    padding: 20px;
    box-shadow: -5px 0 10px rgba(0,0,0,0.1);
    max-width: 25%;
    overflow-y: auto;
  }
  h1, h2 {
    color: #2c3e50;
    text-align: center;
  }
  .container {
    background-color: #fff;
    border-radius: 8px;
    padding: 20px;
    box-shadow: 0 0 10px rgba(0,0,0,0.1);
    position: relative;
    margin-bottom: 120px;
  }
  .question {
    margin-bottom: 20px;
  }
  button {
    background-color: #3498db;
    color: #fff;
    border: none;
    padding: 20px 30px;
    margin: 12px;
    border-radius: 8px;
    cursor: pointer;
    transition: background-color 0.3s, transform 0.1s;
    font-size: 20px;
    min-width: 200px;
  }
  button:hover {
    background-color: #2980b9;
    transform: scale(1.05);
  }
  button:active {
    transform: scale(0.98);
  }
  #report, #finalReport {
    margin-top: 20px;
    border-top: 1px solid #ccc;
    padding-top: 20px;
  }
  textarea {
    width: 100%;
    height: 120px;
    margin-top: 15px;
    padding: 15px;
    border-radius: 8px;
    border: 1px solid #ccc;
    font-size: 18px;
    resize: vertical;
  }
  #finalReportText {
    height: 400px;
  }
  #finalReportContainer {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(255, 255, 255, 0.9);
    z-index: 1000;
    padding: 20px;
    box-sizing: border-box;
    overflow-y: auto;
  }
  #finalReportContent {
    max-width: 800px;
    margin: 0 auto;
    background-color: #fff;
    padding: 30px;
    border-radius: 12px;
    box-shadow: 0 0 20px rgba(0,0,0,0.15);
  }
  #saveButton {
    background-color: #2ecc71;
  }
  #saveButton:hover {
    background-color: #27ae60;
  }
  #restartButton {
    background-color: #f39c12;
    display: none;
  }
  #restartButton:hover {
    background-color: #d35400;
  }
  .options-container {
    display: flex;
    flex-direction: column;
    align-items: center;
  }
  .options-container button {
    width: 80%;
    margin: 10px 0;
    padding: 20px 30px;
    font-size: 24px;
  }
  .navigation-buttons {
    display: flex;
    justify-content: space-between;
    position: fixed;
    bottom: 0;
    left: 0;
    width: 100%;
    background-color: #fff;
    padding: 15px 0;
    box-shadow: 0 -5px 10px rgba(0,0,0,0.1);
  }
  #prevButton, #nextButton {
    background-color: #95a5a6;
    margin: 0 50px;
  }
  #prevButton:hover, #nextButton:hover {
    background-color: #7f8c8d;
  }
  #previewText {
    white-space: pre-wrap;
    font-family: 'Courier New', Courier, monospace;
    font-size: 16px;
    line-height: 1.8;
  }
  #dictateButton {
    background-color: #e74c3c;
  }
  #dictateButton:hover {
    background-color: #c0392b;
  }
  #dictationResult {
    margin-top: 10px;
    font-style: italic;
  }
  .free-text-container {
    margin-top: 20px;
  }
  .free-text-container textarea {
    width: 100%;
    height: 100px;
    margin-bottom: 10px;
  }
</style>
</head>
<body>
  <div class="main-container">
    <div class="content-container">
      <div class="container">
        <h1>Asistente de Informes TAC para Radiólogos</h1>
        <div id="questions"></div>
        <div id="report"></div>
      </div>

      <div id="finalReportContainer">
        <div id="finalReportContent">
          <h2>Edición Final del Informe</h2>
          <textarea id="finalReportText" rows="20"></textarea>
          <button id="dictateFinalReportButton" onclick="startFinalReportDictation()">Dictar Informe Final</button>
          <button id="saveButton" onclick="saveReport()">Guardar y Copiar Informe</button>
          <button id="restartButton" onclick="restartQuestionnaire()" style="display: none;">Reiniciar</button>
        </div>
      </div>
    </div>

    <div class="preview-container">
      <h2>Vista Previa del Informe</h2>
      <div id="previewText"></div>
    </div>
  </div>

  <div class="navigation-buttons">
    <button id="prevButton" onclick="previousQuestion()">Anterior</button>
    <button id="nextButton" onclick="nextQuestion()">Siguiente</button>
  </div>

<script>
const questions = [
  {
    id: 'type',
    text: "¿Qué tipo de exploración TAC está informando?",
    options: ["Torácica", "Abdominal", "Toracoabdominal"]
  },
  {
    id: 'contrast',
    text: "¿Se ha utilizado contraste endovenoso?",
    options: ["Sí", "No"]
  },
  {
    id: 'contrastPhase',
    text: "¿Qué fases de adquisición se han realizado?",
    options: ["Arterial", "Portal", "Arterial y Portal"],
    condition: (answers) => answers.contrast === "Sí"
  },
  {
    id: 'lungBases',
    text: "¿Cómo se observan las bases pulmonares?",
    options: ["Normales", "Atelectasias", "Infiltrados", "Otro"],
    category: "abdomen",
    allowFreeText: true
  },
  {
    id: 'lungs',
    text: "¿Cómo se observan los pulmones?",
    options: ["Normales", "Nódulos", "Infiltrados", "Atelectasias", "Enfisema", "Otro"],
    category: "thorax",
    allowFreeText: true
  },
  {
    id: 'pleura',
    text: "¿Hay alteraciones pleurales?",
    options: ["No", "Derrame", "Engrosamiento", "Neumotórax", "Otro"],
    category: "thorax",
    allowFreeText: true
  },
  {
    id: 'mediastinum',
    text: "¿Cómo se observa el mediastino?",
    options: ["Normal", "Adenopatías", "Masas", "Ensanchamiento", "Otro"],
    category: "thorax",
    allowFreeText: true
  },
  {
    id: 'heart',
    text: "¿Cómo se observa el corazón?",
    options: ["Normal", "Cardiomegalia", "Calcificaciones coronarias", "Derrame pericárdico", "Otro"],
    category: "thorax",
    allowFreeText: true
  },
  {
    id: 'liver',
    text: "¿Cómo se observa el hígado?",
    options: ["Normal", "Lesiones focales", "Hepatomegalia", "Cirrosis", "Esteatosis", "Otro"],
    category: "abdomen",
    allowFreeText: true
  },
  {
    id: 'pancreas',
    text: "¿Cómo se observa el páncreas?",
    options: ["Normal", "Lesiones focales", "Inflamación", "Atrofia", "Otro"],
    category: "abdomen",
    allowFreeText: true
  },
  {
    id: 'spleen',
    text: "¿Cómo se observa el bazo?",
    options: ["Normal", "Esplenomegalia", "Lesiones focales", "Otro"],
    category: "abdomen",
    allowFreeText: true
  },
  {
    id: 'kidneys',
    text: "¿Cómo se observan los riñones?",
    options: ["Normales", "Litiasis", "Quistes", "Masas", "Hidronefrosis", "Otro"],
    category: "abdomen",
    allowFreeText: true
  }
];

let currentQuestion = 0;
let answers = {};
let recognition;
let isRecognitionActive = false;

function displayQuestion() {
  const question = questions[currentQuestion];

  if (question.condition && !question.condition(answers)) {
    nextQuestion();
    return;
  }

  if (answers.type === "Torácica" && question.category === "abdomen") {
    nextQuestion();
    return;
  }
  if (answers.type === "Abdominal" && question.category === "thorax" && question.id !== "lungBases") {
    nextQuestion();
    return;
  }

  const questionContainer = document.getElementById('questions');
  questionContainer.innerHTML = '';

  const questionElement = document.createElement('div');
  questionElement.className = 'question';
  questionElement.innerHTML = `<h2>${question.text}</h2>`;

  const optionsContainer = document.createElement('div');
  optionsContainer.className = 'options-container';

  question.options.forEach(option => {
    const button = document.createElement('button');
    button.textContent = option;
    button.onclick = () => selectOption(option);
    optionsContainer.appendChild(button);
  });

  questionElement.appendChild(optionsContainer);

  if (question.allowFreeText) {
      const freeTextContainer = document.createElement('div');
      freeTextContainer.className = 'free-text-container';
      freeTextContainer.innerHTML = `
          <textarea id="freeTextInput" placeholder="Ingrese texto adicional aquí..."></textarea>
          <button id="dictateButton" onclick="toggleDictation('freeTextInput')">Dictar</button>
          <button id="correctButton" onclick="correctText('freeTextInput')">Corregir</button>
      `;
      questionElement.appendChild(freeTextContainer);
  }

  questionContainer.appendChild(questionElement);

  updateNavigationButtons();
  updatePreview();
}

function selectOption(option) {
  const question = questions[currentQuestion];
  const freeTextInput = document.getElementById('freeTextInput');

  if (freeTextInput && freeTextInput.value.trim() !== '') {
    answers[question.id] = freeTextInput.value.trim();
  } else {
    answers[question.id] = option;
  }

  nextQuestion();
}

const question = questions[currentQuestion];
if (question.allowFreeText) {
    const freeTextContainer = document.createElement('div');
    freeTextContainer.className = 'free-text-container';
    freeTextContainer.innerHTML = `
        <textarea id="freeTextInput" placeholder="Ingrese texto adicional aquí..."></textarea>
        <button id="dictateButton" onclick="toggleDictation('freeTextInput')">Dictar</button>
        <button id="correctButton" onclick="correctText('freeTextInput')">Corregir</button>
    `;
    questionElement.appendChild(freeTextContainer);
}

function correctText(targetElementId) {
    const targetElement = document.getElementById(targetElementId);
    if (!targetElement) {
        console.error('Target element not found:', targetElementId);
        return;
    }

    const selectedText = targetElement.value.substring(targetElement.selectionStart, targetElement.selectionEnd);

    if (selectedText) {
        const correction = prompt("¿Qué es lo que querías decir?", selectedText);
        if (correction !== null) {
            targetElement.setRangeText(correction, targetElement.selectionStart, targetElement.selectionEnd, 'end');

            // Almacenar la corrección (opcional)
            localStorage.setItem(`correction_${selectedText}`, correction);
        }
    } else {
        alert("Por favor selecciona el texto que deseas corregir.");
    }

    updatePreview();  // Actualiza la vista previa del informe
}

function toggleDictation(targetElementId) {
    if (!recognition) {
        recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
        recognition.lang = 'es-ES';
        recognition.interimResults = false;
        recognition.maxAlternatives = 1;
        recognition.continuous = true;
    }

    if (isRecognitionActive) {
        recognition.stop();
        isRecognitionActive = false;
        console.log('Recognition stopped');
    } else {
    recognition.onresult = function(event) {
        const targetElement = document.getElementById(targetElementId);
        let transcript = event.results[event.results.length - 1][0].transcript;
        // Aplicar corrección almacenada si existe
        const storedCorrection = localStorage.getItem(`correction_${transcript}`);
        if (storedCorrection) {
            transcript = storedCorrection;
        }
        const selectionStart = targetElement.selectionStart;
        const selectionEnd = targetElement.selectionEnd;
        const beforeText = targetElement.value.slice(0, selectionStart);
        const afterText = targetElement.value.slice(selectionEnd);

        // Reemplazar "punto y aparte" por ".\n" para salto de línea
        transcript = transcript.replace(/\bpunto y aparte\b/g, '.\n');

        //  Reemplazar "Coma" por "," y "punto" por "."
        transcript = transcript.replace(/\bcoma\b/g, ',');
        transcript = transcript.replace(/\bpunto\b/g, '.');

        // Asegurar que no haya espacios antes de los signos de puntuación y que haya un espacio después
        transcript = transcript.replace(/\s*([,.])/g, '$1 ').trim();

        // Eliminar el espacio extra después de un punto seguido de un salto de línea
        transcript = transcript.replace(/\. \n/g, '.\n');

        // Capitalizar la primera letra después de cada punto o salto de línea
        transcript = transcript.replace(/(?:\.\s+|\.\n+)(\w)/g, (match, p1) => {
            return '. ' + p1.toUpperCase();
        });

        // Capitalizar la primera palabra si es el comienzo del texto o después de un punto
        if (beforeText.trim() === '' || beforeText.trim().endsWith('.')) {
            transcript = transcript.charAt(0).toUpperCase() + transcript.slice(1);
        }

        // Detectar si el texto antes de la selección termina en una palabra y no en un signo de puntuación
        if (beforeText && !beforeText.endsWith(' ') && !beforeText.endsWith('\n') && !/[,.]\s*$/.test(beforeText)) {
            transcript = ' ' + transcript; // Añadir un espacio antes del nuevo texto
        }

        // Detectar si el texto después de la selección comienza con una palabra
        if (afterText && !afterText.startsWith(' ') && !/^[,.]/.test(afterText)) {
            transcript += ' '; // Añadir un espacio después del nuevo texto
        }

        // Reducir múltiples espacios a uno solo
        transcript = transcript.replace(/\s{2,}/g, ' ');

        // Insertar el texto, reemplazando la selección si existe
        targetElement.value = beforeText + transcript + afterText;

        // Ajustar la posición del cursor al final del texto insertado
        targetElement.selectionStart = targetElement.selectionEnd = selectionStart + transcript.length;

        if (targetElementId === 'freeTextInput') {
            const question = questions[currentQuestion];
            answers[question.id] = targetElement.value.trim();
        }
        updatePreview();
    };

        recognition.onerror = function(event) {
            console.error('Speech recognition error:', event.error);
        };

        recognition.start();
        isRecognitionActive = true;
        console.log('Recognition started');
    }
}



function correctText(targetElementId) {
    const targetElement = document.getElementById(targetElementId);
    if (!targetElement) {
        console.error('Target element not found:', targetElementId);
        return;
    }

    const selectedText = targetElement.value.substring(targetElement.selectionStart, targetElement.selectionEnd);

    if (selectedText) {
        const correction = prompt("¿Qué es lo que querías decir?", selectedText);
        if (correction !== null) {
            targetElement.setRangeText(correction, targetElement.selectionStart, targetElement.selectionEnd, 'end');

            // Almacenar la corrección (opcional)
            localStorage.setItem(`correction_${selectedText}`, correction);
        }
    } else {
        alert("Por favor selecciona el texto que deseas corregir.");
    }

    updatePreview();  // Actualiza la vista previa del informe
}




function nextQuestion() {
  if (currentQuestion < questions.length - 1) {
    currentQuestion++;
    displayQuestion();
  } else {
    showFinalReport();
  }
}

function previousQuestion() {
  if (currentQuestion > 0) {
    do {
      currentQuestion--;
      const question = questions[currentQuestion];

      if (
        (answers.type === "Abdominal" && (question.category === "abdomen" || question.id === "lungBases")) ||
        (answers.type === "Torácica" && question.category === "thorax") ||
        answers.type === "Toracoabdominal" ||
        !question.category
      ) {
        break;
      }
    } while (currentQuestion > 0);

    displayQuestion();
  }
}

function updateNavigationButtons() {
  const prevButton = document.getElementById('prevButton');
  const nextButton = document.getElementById('nextButton');

  prevButton.style.display = currentQuestion === 0 ? 'none' : 'inline-block';
  nextButton.textContent = currentQuestion === questions.length - 1 ? 'Finalizar' : 'Siguiente';
}

function showFinalReport() {
  const finalReportContainer = document.getElementById('finalReportContainer');
  const finalReportText = document.getElementById('finalReportText');
  finalReportContainer.style.display = 'block';
  finalReportText.value = generateReport();
}

function generateReport() {
  let report = '';

  if (answers.type && answers.contrast) {
    const tacType = answers.type.toLowerCase();
    const contrastUsed = answers.contrast === 'Sí' ? 'tras' : 'sin';
    const contrastPhase = answers.contrast === 'Sí' && answers.contrastPhase ? ` con adquisición de imágenes en fase ${answers.contrastPhase.toLowerCase()}` : '';

    report += `Se realiza exploración ${tacType} ${contrastUsed} la administración endovenosa de contraste${contrastPhase}.\n\n`;
  }

  const thoraxQuestions = questions.filter(q => q.category === 'thorax');
  const abdominalQuestions = questions.filter(q => q.category === 'abdomen');

  if (answers.type === 'Torácica' || answers.type === 'Toracoabdominal') {
    thoraxQuestions.forEach(q => {
      if (answers[q.id]) {
        report += `${answers[q.id]}\n`;
      }
    });
  }

  if (answers.type === 'Abdominal' || answers.type === 'Toracoabdominal') {
    if (answers.lungBases) {
      report += `${answers.lungBases}\n`;
    }
    abdominalQuestions.forEach(q => {
      if (answers[q.id] && q.id !== 'lungBases') {
        report += `${answers[q.id]}\n`;
      }
    });
    report += '\n';
  }

  return report;
}

function saveReport() {
  const finalReport = document.getElementById('finalReportText').value;
  navigator.clipboard.writeText(finalReport).then(() => {
    alert('Informe copiado al portapapeles');
    document.getElementById('restartButton').style.display = 'inline-block';
  }).catch(err => {
    console.error('Error al copiar al portapapeles:', err);
  });
}

function restartQuestionnaire() {
  currentQuestion = 0;
  answers = {};
  document.getElementById('finalReportContainer').style.display = 'none';
  displayQuestion();
}

function updatePreview() {
  const previewText = document.getElementById('previewText');
  previewText.innerHTML = generateReport().replace(/\n/g, '<br>');
}

// Iniciar el cuestionario al cargar la página
window.onload = () => {
  displayQuestion();
};

// Inicializa la función de dictado para el informe final
function startFinalReportDictation() {
  toggleDictation('finalReportText');
}
</script>
</body>
</html>
