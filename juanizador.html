<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Asistente de Informes Radiológicos</title>
    <style>
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #3498db;
            --accent-color: #e74c3c;
            --light-color: #ecf0f1;
            --dark-color: #34495e;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            background-color: var(--light-color);
            color: var(--primary-color);
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            background-color: var(--primary-color);
            color: white;
            /* padding: 10px 0; */ /* Modified for new button */
            text-align: center;
            border-radius: 5px;
            margin-bottom: 20px;
            /* Added for new button */
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 20px;
        }
        
        header h1 { /* Ensure h1 doesn't take full width if button is there */
            margin: 0;
            flex-grow: 1; /* Allow h1 to take space */
            text-align: center; /* Keep it centered if possible*/
        }


        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .input-section, .output-section {
            background-color: white;
            border-radius: 5px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .section-title {
            margin-top: 0;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--secondary-color);
            color: var(--primary-color);
        }

        .voice-input {
            text-align: center;
            margin-bottom: 20px;
        }

        #microphone-btn {
            background-color: var(--secondary-color);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 50px;
            cursor: pointer;
            font-size: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto;
            transition: all 0.3s ease;
        }

        #microphone-btn:hover {
            background-color: var(--dark-color);
        }

        #microphone-btn svg {
            margin-right: 10px;
            height: 20px;
            width: 20px;
        }

        #microphone-btn.recording {
            background-color: var(--accent-color);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% {
                transform: scale(1);
            }
            50% {
                transform: scale(1.05);
            }
            100% {
                transform: scale(1);
            }
        }

        #transcript {
            width: 100%;
            min-height: 150px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            resize: vertical;
            margin-bottom: 20px;
        }

        .categorized-content {
            margin-bottom: 20px;
        }

        .category {
            background-color: #f8f9fa;
            border-left: 4px solid var(--secondary-color);
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 0 5px 5px 0;
        }

        .category h3 {
            margin-top: 0;
            color: var(--dark-color);
        }

        .category-content {
            margin-left: 10px;
            color: #666;
        }

        #final-report {
            white-space: pre-wrap;
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            border: 1px solid #ddd;
        }

        .buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .btn {
            background-color: var(--secondary-color);
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            flex: 1;
            transition: background-color 0.3s ease;
        }

        .btn:hover {
            background-color: var(--dark-color);
        }

        .btn-danger {
            background-color: var(--accent-color);
        }
         .btn-danger:hover {
            background-color: #c0392b; /* Darker red */
        }


        .btn-success {
            background-color: #27ae60;
        }

        .loading {
            text-align: center;
            margin: 20px 0;
            display: none;
        }

        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border-left-color: var(--secondary-color);
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }
            100% {
                transform: rotate(360deg);
            }
        }

        .status-message {
            margin-top: 10px;
            font-style: italic;
            color: #666;
        }

        .technique-selector {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
            background-color: white;
            padding: 15px;
            border-radius: 5px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .selector-group {
            display: flex;
            flex-direction: column;
            min-width: 200px;
        }

        .selector-group label {
            margin-bottom: 5px;
            font-weight: bold;
            color: var(--primary-color);
        }

        .selector-group select {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background-color: white;
            font-size: 14px;
        }

        .technique-description {
            margin-bottom: 20px;
            background-color: #f8f9fa;
            padding: 10px 15px;
            border-radius: 5px;
            border-left: 4px solid var(--secondary-color);
        }

        .technique-description h3 {
            margin-top: 0;
            margin-bottom: 10px;
            color: var(--dark-color);
        }

        .technique-description p {
            margin: 0;
        }

        .checkbox-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .checkbox-group label {
            display: flex;
            align-items: center;
            gap: 5px;
            font-weight: normal;
        }

        .finding-item {
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .finding-text {
            flex: 1;
        }

        .finding-controls {
            display: flex;
            gap: 5px;
        }

        .category-reassign {
            padding: 3px 5px;
            font-size: 12px;
            border: 1px solid #ddd;
            border-radius: 3px;
            background-color: white;
            color: var(--primary-color);
        }

        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
            }
             header {
                flex-direction: column;
             }
             header h1 {
                 margin-bottom: 10px;
             }
             header button#backToDictationBtn {
                 width: 100%;
                 margin-left: 0;
             }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Asistente de Informes Radiológicos</h1>
            <button id="backToDictationBtn" class="btn btn-danger" style="margin-left: 20px; flex-shrink: 0; flex-basis: auto; flex-grow: 0;">Volver a dictado</button>
        </header>
        
        <div class="technique-selector">
            <div class="selector-group">
                <label for="imaging-technique">Técnica de Imagen:</label>
                <select id="imaging-technique">
                    <option value="tac">TAC</option>
                    <option value="rm">RM</option>
                    <option value="eco">Ecografía</option>
                </select>
            </div>
            
            <div class="selector-group" id="tac-scope-container">
                <label for="tac-scope">Alcance del TAC:</label>
                <select id="tac-scope">
                    <option value="toracoabdominal">Toracoabdominal</option>
                    <option value="torax">Torácico</option>
                    <option value="abdomen">Abdominal</option>
                </select>
            </div>
            
            <div class="selector-group" id="rm-type-container" style="display: none;">
                <label for="rm-type">Tipo de RM:</label>
                <select id="rm-type">
                    <option value="hepatica">RM Hepática</option>
                    <option value="colangio">ColangioRM</option>
                    <option value="pelvis-neo">RM Pelvis NEO</option>
                    <option value="pelvis-fist">RM Pelvis FIST</option>
                    <option value="entero">EnteroRM</option>
                </select>
            </div>
            
            <div class="selector-group" id="contrast-container">
                <label for="contrast-use">Contraste:</label>
                <select id="contrast-use">
                    <option value="sin">Sin contraste</option>
                    <option value="con">Con contraste</option>
                </select>
            </div>
            
            <div class="selector-group" id="phase-container" style="display: none;">
                <label for="contrast-phase">Fase:</label>
                <div class="checkbox-group">
                    <label><input type="checkbox" name="phase" value="arterial"> Arterial</label>
                    <label><input type="checkbox" name="phase" value="portal"> Portal</label>
                    <label><input type="checkbox" name="phase" value="tardia"> Tardía</label>
                </div>
            </div>
        </div>
        
        <div class="main-content">
            <div class="input-section">
                <h2 class="section-title">Entrada de Hallazgos</h2>
                
                <div class="voice-input">
                    <button id="microphone-btn">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3z"/>
                            <path d="M17 11c0 2.76-2.24 5-5 5s-5-2.24-5-5H5c0 3.53 2.61 6.43 6 6.92V21h2v-3.08c3.39-.49 6-3.39 6-6.92h-2z"/>
                        </svg>
                        Iniciar Dictado
                    </button>
                </div>
                
                <textarea id="transcript" placeholder="Los hallazgos dictados aparecerán aquí..."></textarea>
                
                <div class="buttons">
                    <button id="categorize-btn" class="btn">Categorizar Hallazgos</button>
                    <button id="clear-btn" class="btn btn-danger">Limpiar</button>
                </div>
                
                <div class="loading" id="categorizing-loading">
                    <div class="spinner"></div>
                    <p class="status-message">Categorizando hallazgos...</p>
                </div>
                
                <div class="categorized-content" id="categorized-content">
                    <!-- Categorías generadas dinámicamente -->
                </div>
            </div>
            
            <div class="output-section">
                <h2 class="section-title">Informe Final</h2>
                
                <div class="buttons">
                    <button id="generate-report-btn" class="btn btn-success">Generar Informe</button>
                    <button id="copy-report-btn" class="btn">Copiar Informe</button>
                </div>
                
                <div class="loading" id="report-loading">
                    <div class="spinner"></div>
                    <p class="status-message">Generando informe completo...</p>
                </div>
                
                <div class="technique-description" id="technique-description">
                    <h3>Técnica</h3>
                    <p id="technique-text"></p>
                </div>
                
                <div id="final-report">
                    El informe generado aparecerá aquí...
                </div>
            </div>
        </div>
    </div>
    
    <script type="module">
        import { GoogleGenerativeAI } from "https://esm.run/@google/generative-ai";

        /*********************
         * CONFIG CONSTANTS
         *********************/
        // API Configuration
        const API_KEY = 'AIzaSyBsKWbE6KgNaolK9BxDNDdviNw3pM7sOv0'; // Preserved API Key
        const MODEL_NAME = 'gemini-1.5-flash';

        // Initialize the Google GenAI API
        const genAI = new GoogleGenerativeAI(API_KEY);
        const model = genAI.getGenerativeModel({ model: MODEL_NAME });

        // Definición de las categorías anatómicas
        const anatomicalCategories = [
            { id: 0, name: "Tiroides/glándula tiroidea" },
            { id: 1, name: "Estructuras mediastínicas vasculares y/o corazón" },
            { id: 2, name: "Adenopatías mediastínicas" },
            { id: 3, name: "Parénquima pulmonar" },
            { id: 4, name: "Derrame pleural y cambios secundarios" },
            { id: 5, name: "Hígado, porta y confluente esplenomesentérico venoso" },
            { id: 6, name: "Vesícula y vía biliar" },
            { id: 7, name: "Páncreas" },
            { id: 8, name: "Bazo, glándulas suprarrenales, riñones, vías excretoras, uréteres y vejiga urinaria" },
            { id: 9, name: "Cámara gástrica, asas intestinales" },
            { id: 10, name: "Líquido libre o adenopatías intra-abdominales" },
            { id: 11, name: "Aorta y grandes vasos mesentéricos" },
            { id: 12, name: "Esqueleto axial" },
            { id: 13, name: "Otros hallazgos" }
        ];

        // Prompts específicos para cada categoría
        const categoryPrompts = {
            0: "Describe SOLO los hallazgos mencionados en la glándula tiroidea, sin añadir interpretaciones o elaboraciones. Sé conciso y específico. NO menciones la técnica de imagen utilizada (TAC, RM, etc.) en tu descripción. Si no hay hallazgos, devuelve EXACTAMENTE: 'Glándula tiroidea de tamaño y morfología normales, sin nódulos ni otras alteraciones radiológicas significativas.'",
            1: "Describe SOLO los hallazgos mencionados en estructuras mediastínicas vasculares y/o corazón, sin añadir interpretaciones o elaboraciones. Sé conciso y específico. NO menciones la técnica de imagen utilizada (TAC, RM, etc.) en tu descripción. Si no hay hallazgos, devuelve EXACTAMENTE: 'Estructuras mediastinicas vasculares sin hallazgos morfológicos de interés.'",
            2: "Describe SOLO los hallazgos mencionados en adenopatías mediastínicas, sin añadir interpretaciones o elaboraciones. Sé conciso y específico. NO menciones la técnica de imagen utilizada (TAC, RM, etc.) en tu descripción. Si no hay hallazgos, devuelve EXACTAMENTE: 'No se identifican adenopatías mediastínicas de tamaño significativo.'",
            3: "Describe SOLO los hallazgos mencionados en el parénquima pulmonar, sin añadir interpretaciones o elaboraciones. Sé conciso y específico. NO menciones la técnica de imagen utilizada (TAC, RM, etc.) en tu descripción. Si no hay hallazgos, devuelve EXACTAMENTE: 'En el parénquima pulmonar no existen imágenes nodulares ni aumentos de densidad sugestivos de afectación patológica'",
            4: "Describe SOLO los hallazgos mencionados sobre derrame pleural, sin añadir interpretaciones o elaboraciones. Sé conciso y específico. NO menciones la técnica de imagen utilizada (TAC, RM, etc.) en tu descripción. Si no hay hallazgos, devuelve EXACTAMENTE: 'No se objetiva derrame pleural.'",
            5: " A la hora de describir los hallazgos en el hígado, porta y confluente esplenomesentérico venoso me gusta seguir un esquema. En primer lugar hay que hablar si hay rasgos de hepatopatía crónica o no. Si los hay me gusta la frase el hígado es de contornos lobulados y parénquima discretamente heterogéneo en relación con rasgos de hepatopatía crónica. Si no los hay me gusta la frase el hígado es de bordes lisos y densidad homogénea. Una de estas 2 frases ha de estar incluida necesariamente en el informe. A partir de ahí describe si existen lesiones ocupantes de espacio brevemente con las características radiológicas principales de forma concisa teniendo en cuenta si estamos dictando un TAC, una resonancia o una eco ( no más de una frase de las características de cada tipo de lesión) con las caracteristicas que tambien se te aporten en los hallazgos. Describe también cualquier hallazgo relativo a porta, vena esplénica, vena mesentérica y confluente esplenomesentérico venoso, sin añadir interpretaciones o elaboraciones. NO menciones la técnica de imagen utilizada (TAC, RM, etc.) en tu descripción. Sé conciso y específico. Si no hay hallazgos, devuelve EXACTAMENTE: 'El hígado es de bordes lisos y densidad homogénea no identificándose lesiones ocupantes de espacio. Vena porta, esplénica y mesentérica de calibre normal, permeables.'",
            6: "Describe SOLO los hallazgos mencionados en vesícula y vía biliar, sin añadir interpretaciones o elaboraciones. Sé conciso y específico. NO menciones la técnica de imagen utilizada (TAC, RM, etc.) en tu descripción. Si no hay hallazgos, devuelve EXACTAMENTE: 'Vesícula biliar normodistendida, de paredes finas, sin evidencia de litiasis en su interior. Vía biliar intra y extrahepática no dilatada.'",
            7: "Describe SOLO los hallazgos mencionados en el páncreas, sin añadir interpretaciones o elaboraciones. Sé conciso y específico. NO menciones la técnica de imagen utilizada (TAC, RM, etc.) en tu descripción. Si no hay hallazgos, devuelve EXACTAMENTE: 'Páncreas homogéneo y bien definido sin lesiones focales ni dilatación del ducto pancreático principal.'",
            8: "Describe SOLO los hallazgos mencionados en bazo, glándulas suprarrenales, riñones, vías excretoras, uréteres y vejiga urinaria, sin añadir interpretaciones o elaboraciones. Sé conciso y específico. NO menciones la técnica de imagen utilizada (TAC, RM, etc.) en tu descripción. Si no hay hallazgos, devuelve EXACTAMENTE: 'Bazo, glándulas suprarrenales y riñones de tamaño, morfología y densidad normales, sin evidencia de lesiones focales. Vías excretoras, uréteres y vejiga urinaria sin alteraciones radiológicas significativas.'",
            9: "Describe SOLO los hallazgos mencionados en cámara gástrica y asas intestinales, sin añadir interpretaciones o elaboraciones. Sé conciso y específico. NO menciones la técnica de imagen utilizada (TAC, RM, etc.) en tu descripción. Si no hay hallazgos, devuelve EXACTAMENTE: 'Cámara gástrica moderadamente distendida sin hallazgos relevantes. Asas intestinales de delgado y marco cólico sin engrosamientos parietales ni cambios de calibre significativos.'",
            10: "Describe SOLO los hallazgos mencionados sobre líquido libre o adenopatías intra-abdominales, sin añadir interpretaciones o elaboraciones. Sé conciso y específico. NO menciones la técnica de imagen utilizada (TAC, RM, etc.) en tu descripción. Si no hay hallazgos, devuelve EXACTAMENTE: 'No se observa líquido libre ni adenopatías intra-abdominales de aspecto patológico.'",
            11: "Describe SOLO los hallazgos mencionados en aorta y grandes vasos mesentéricos, sin añadir interpretaciones o elaboraciones. Sé conciso y específico. NO menciones la técnica de imagen utilizada (TAC, RM, etc.) en tu descripción. Si no hay hallazgos, devuelve EXACTAMENTE: 'Aorta y grandes vasos mesentéricos de calibre normal, sin hallazgos significativos.'",
            12: "Describe SOLO los hallazgos mencionados en el esqueleto axial, sin añadir interpretaciones o elaboraciones. Sé conciso y específico. NO menciones la técnica de imagen utilizada (TAC, RM, etc.) en tu descripción. Si no hay hallazgos, devuelve EXACTAMENTE: 'Esqueleto axial incluido en el estudio sin lesiones focales ni anomalías morfológicas relevantes.'",
            13: "Describe SOLO los hallazgos que no corresponden claramente a otras categorías anatómicas. Sé conciso y específico. NO menciones la técnica de imagen utilizada (TAC, RM, etc.) en tu descripción. Si no hay hallazgos, devuelve EXACTAMENTE: 'No hay otros hallazgos relevantes que reportar.'"
        };

        /*********************
         * SPEECH RECOGNITION
         *********************/
        // Variables para el reconocimiento de voz
        let recognition;
        let isRecording = false;
        let transcriptArea; // Declared here to be accessible

        // Inicializar reconocimiento de voz si está disponible
        function initSpeechRecognition() {
            if ('webkitSpeechRecognition' in window) {
                recognition = new webkitSpeechRecognition();
                recognition.continuous = true;
                recognition.interimResults = true;
                recognition.lang = 'es-ES';
                
                recognition.onresult = (event) => {
                    let finalTranscript = '';
                    for (let i = event.resultIndex; i < event.results.length; ++i) {
                        if (event.results[i].isFinal) {
                            let transcript = event.results[i][0].transcript;
                            
                            // Convertir comandos de dictado a puntuación
                            transcript = transcript.replace(/\s+punto(\s+|$)/gi, '. ');
                            transcript = transcript.replace(/\s+coma(\s+|$)/gi, ', ');
                            
                            finalTranscript += transcript;
                        }
                    }
                    
                    if (finalTranscript) {
                        // Insertar o reemplazar el texto seleccionado
                        insertAtCaret(transcriptArea, finalTranscript);
                    }
                };
                
                recognition.onerror = (event) => {
                    console.error('Error en reconocimiento de voz:', event.error);
                    toggleRecording();
                };
            } else {
                const microphoneBtn = document.getElementById('microphone-btn'); // Get it here
                microphoneBtn.textContent = 'Reconocimiento de voz no soportado';
                microphoneBtn.disabled = true;
            }
        }

        // Función para insertar texto en la posición del cursor o reemplazar la selección
        function insertAtCaret(textArea, text) {
            const start = textArea.selectionStart;
            const end = textArea.selectionEnd;
            
            // Reemplazar el texto seleccionado
            textArea.value = textArea.value.substring(0, start) + text + textArea.value.substring(end);
            
            // Mover el cursor al final del texto insertado
            textArea.selectionStart = textArea.selectionEnd = start + text.length;
            
            // Añadir un espacio después del punto o la coma si es el final del texto
            if (text === "." || text === ",") {
                textArea.value = textArea.value.substring(0, start + 1) + " " + textArea.value.substring(start + 1);
                textArea.selectionStart = textArea.selectionEnd = start + 2;
            }
        }

        // Alternar grabación
        function toggleRecording() {
            const microphoneBtn = document.getElementById('microphone-btn'); // Get it here
            if (recognition) {
                if (isRecording) {
                    recognition.stop();
                    microphoneBtn.classList.remove('recording');
                    microphoneBtn.innerHTML = `
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3z"/>
                            <path d="M17 11c0 2.76-2.24 5-5 5s-5-2.24-5-5H5c0 3.53 2.61 6.43 6 6.92V21h2v-3.08c3.39-.49 6-3.39 6-6.92h-2z"/>
                        </svg>
                        Iniciar Dictado
                    `;
                } else {
                    recognition.start();
                    microphoneBtn.classList.add('recording');
                    microphoneBtn.innerHTML = `
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3z"/>
                            <path d="M17 11c0 2.76-2.24 5-5 5s-5-2.24-5-5H5c0 3.53 2.61 6.43 6 6.92V21h2v-3.08c3.39-.49 6-3.39 6-6.92h-2z"/>
                        </svg>
                        Detener Dictado
                    `;
                }
                isRecording = !isRecording;
            }
        }

        /*********************
         * API SERVICE
         *********************/
        // Variables globales para API
        let categorizedFindings = {};

        // Función para consultar la API de Gemini
        async function queryGeminiAPI(prompt) {
            try {
                const result = await model.generateContent(prompt);
                const response = await result.response;
                return response.text();
            } catch (error) {
                console.error('Error al consultar la API:', error);
                return null;
            }
        }

        // Categorizar hallazgos
        async function categorizeFindings(availableCategories = []) {
            const transcript = document.getElementById('transcript').value.trim();
            const categorizedContent = document.getElementById('categorized-content');
            const categorizingLoading = document.getElementById('categorizing-loading');
            const imagingTechniqueSelect = document.getElementById('imaging-technique');
            const tacScopeSelect = document.getElementById('tac-scope');
            
            if (!transcript) {
                alert('Por favor, dicte o escriba algún hallazgo primero.');
                return;
            }
            
            categorizingLoading.style.display = 'block';
            
            // Añadir siempre la categoría "Otros hallazgos"
            if (!availableCategories.includes(13)) {
                availableCategories.push(13);
            }
            
            const filteredCategories = anatomicalCategories.filter(cat => 
                availableCategories.length === 0 || availableCategories.includes(cat.id)
            );
            
            const categoryNames = filteredCategories.map(cat => `${cat.id}. ${cat.name}`).join('\n');
            const technique = imagingTechniqueSelect.value;
            const tacScope = technique === 'tac' ? tacScopeSelect.value : null;
            
            // Cargar diccionario de aprendizaje
            let learningDictionary = JSON.parse(localStorage.getItem('findingsLearningDictionary')) || {};
            
            const prompt = `
            Eres un radiólogo experto que debe categorizar los siguientes hallazgos radiológicos en las categorías anatómicas apropiadas.
            
            La técnica de imagen es: ${technique.toUpperCase()}${tacScope ? ` (${tacScope})` : ''}
            
            Las categorías disponibles son:
            ${categoryNames}
            
            Hallazgos a categorizar:
            ${transcript}
            
            ${Object.keys(learningDictionary).length > 0 ? `
            Aquí hay ejemplos de hallazgos y cómo han sido categorizados previamente:
            ${Object.entries(learningDictionary).map(([finding, categoryId]) => 
                `"${finding}" => Categoría ${categoryId}`).join('\n')}
            ` : ''}
            
            Por favor, asigna cada hallazgo a la categoría más apropiada. Devuelve un JSON con la siguiente estructura:
            {
              "1": ["hallazgo 1", "hallazgo 2"],
              "2": ["hallazgo 3"],
              ...
            }
            Donde las claves son los números de las categorías y los valores son arrays de hallazgos asignados a esas categorías.
            Incluye solo las categorías disponibles que tienen hallazgos. 
            Si un hallazgo no corresponde claramente a ninguna categoría anatómica, asígnalo a la categoría 13 "Otros hallazgos".
            Intenta utilizar los ejemplos previos para categorizar hallazgos similares de manera consistente.
            Devuelve SOLO el objeto JSON, sin texto adicional.
            `;
            
            try {
                const response = await queryGeminiAPI(prompt);
                
                if (!response) {
                    throw new Error('No se recibió respuesta de la API');
                }
                
                let jsonStr = response.trim();
                
                if (jsonStr.includes('{') && jsonStr.includes('}')) {
                    const startIndex = jsonStr.indexOf('{');
                    const endIndex = jsonStr.lastIndexOf('}') + 1;
                    jsonStr = jsonStr.substring(startIndex, endIndex);
                }
                
                try {
                    categorizedFindings = JSON.parse(jsonStr);
                    displayCategorizedFindings();
                } catch (parseError) {
                    console.error('Error al parsear JSON:', parseError);
                    console.error('JSON recibido:', jsonStr);
                    
                    const alternativeJson = {};
                    const categoryRegex = /"(\d+)":\s*\[(.*?)\]/gs;
                    let match;
                    
                    while ((match = categoryRegex.exec(jsonStr)) !== null) {
                        const categoryId = match[1];
                        const findingsStr = match[2];
                        
                        const findingsRegex = /"(.*?)"/g;
                        const findings = [];
                        let findingMatch;
                        
                        while ((findingMatch = findingsRegex.exec(findingsStr)) !== null) {
                            findings.push(findingMatch[1]);
                        }
                        
                        if (findings.length > 0) {
                            alternativeJson[categoryId] = findings;
                        }
                    }
                    
                    if (Object.keys(alternativeJson).length > 0) {
                        categorizedFindings = alternativeJson;
                        displayCategorizedFindings();
                    } else {
                        throw new Error('No se pudo extraer información válida del JSON');
                    }
                }
            } catch (error) {
                console.error('Error al categorizar hallazgos:', error);
                alert('Error al categorizar hallazgos. Por favor, intente nuevamente.');
            } finally {
                categorizingLoading.style.display = 'none';
            }
        }

        // Generar informe completo
        async function generateCompleteReport() {
            const finalReport = document.getElementById('final-report');
            const reportLoading = document.getElementById('report-loading');
            const imagingTechniqueSelect = document.getElementById('imaging-technique');
            const tacScopeSelect = document.getElementById('tac-scope');
            const rmTypeSelect = document.getElementById('rm-type');
            const contrastUseSelect = document.getElementById('contrast-use');
            
            if (Object.keys(categorizedFindings).length === 0) {
                alert('Primero debe categorizar los hallazgos.');
                return;
            }
            
            reportLoading.style.display = 'block';
            finalReport.textContent = 'Generando informe...';
            
            const technique = imagingTechniqueSelect.value.toUpperCase();
            const tacScope = technique === 'TAC' ? tacScopeSelect.value : null;
            const rmType = technique === 'RM' ? rmTypeSelect.value : null;
            const contrastUse = technique === 'TAC' ? contrastUseSelect.value : null;
            
            let phases = [];
            if (technique === 'TAC' && contrastUse === 'con') {
                phases = Array.from(document.querySelectorAll('input[name="phase"]:checked'))
                    .map(checkbox => checkbox.value);
            }
            
            let fullReport = '';
            
            // Asegurarse de que availableCategories esté definido
            const availableCategories = window.availableCategories || [];
            
            for (const category of anatomicalCategories) {
                const categoryId = category.id.toString();
                
                if (!availableCategories.includes(category.id)) {
                    continue;
                }
                
                const findings = categorizedFindings[categoryId] || [];
                
                const prompt = `
                ${categoryPrompts[categoryId]}
                
                Técnica de imagen: ${technique}${tacScope ? ` (${tacScope})` : ''}
                
                Hallazgos encontrados: ${findings.length > 0 ? findings.join('. ') : 'Ninguno'}
                
                Redacta un párrafo conciso y profesional, usando terminología radiológica adecuada específica para ${technique}. 
                MUY IMPORTANTE: NO menciones la técnica de imagen (TAC, RM, eco, etc.) en tu descripción de hallazgos.
                `;
                
                try {
                    const sectionReport = await queryGeminiAPI(prompt);
                    if (sectionReport) {
                        fullReport += `${sectionReport.trim()}\n`;
                    }
                } catch (error) {
                    console.error(`Error al generar informe para categoría ${categoryId}:`, error);
                    fullReport += `Error al generar esta sección.\n`;
                }
            }
            
            try {
                const allFindings = [];
                
                for (const categoryId in categorizedFindings) {
                    if (availableCategories.includes(parseInt(categoryId))) {
                        allFindings.push(...categorizedFindings[categoryId]);
                    }
                }
                
                const conclusionPrompt = `
                Técnica de imagen: ${technique}${tacScope ? ` (${tacScope})` : ''}${rmType ? ` (${rmType})` : ''}
                
                Basado en estos hallazgos radiológicos exactos:
                ${allFindings.join('. ')}
                
                Genera una conclusión muy concisa (máximo 2-3 líneas) que describa SOLO los 2-3 hallazgos más relevantes o significativos. 
                Para hallazgos menores adicionales, sustituye todos ellos por la frase "Ver informe descriptivo."
                Limítate a los datos proporcionados, sin añadir interpretaciones o elaboraciones creativas.
                MUY IMPORTANTE: NO menciones la técnica de imagen (TAC, RM, eco, etc.) en tu conclusión.
                Si no hay hallazgos significativos, devuelve EXACTAMENTE: "No se observan alteraciones radiológicas significativas."
                `;
                
                const conclusion = await queryGeminiAPI(conclusionPrompt);
                if (conclusion) {
                    fullReport += `\n${conclusion.trim()}`;
                }
            } catch (error) {
                console.error('Error al generar conclusión:', error);
                fullReport += '\nError al generar conclusión.';
            }
            
            finalReport.textContent = fullReport;
            reportLoading.style.display = 'none';
        }

        // Nueva función para enseñar a la app dónde ubicar un hallazgo
        function teachFindingCategorization(finding, categoryId) {
            // Cargar diccionario de aprendizaje
            let learningDictionary = JSON.parse(localStorage.getItem('findingsLearningDictionary')) || {};
            
            // Guardar o actualizar la categorización
            learningDictionary[finding] = categoryId;
            
            // Guardar en localStorage
            localStorage.setItem('findingsLearningDictionary', JSON.stringify(learningDictionary));
            
            // Notificar al usuario
            alert(`La app ha aprendido que "${finding}" pertenece a la categoría "${anatomicalCategories.find(cat => cat.id === parseInt(categoryId)).name}"`);
        }

        /*********************
         * UI FUNCTIONS
         *********************/
        // Mostrar hallazgos categorizados
        function displayCategorizedFindings() {
            const categorizedContent = document.getElementById('categorized-content');
            categorizedContent.innerHTML = '';
            
            if (Object.keys(categorizedFindings).length === 0) {
                categorizedContent.innerHTML = '<p>No hay hallazgos categorizados.</p>';
                return;
            }
            
            // Asegurarse de que availableCategories esté definido
            const availableCategories = window.availableCategories || [];
            
            for (const categoryId in categorizedFindings) {
                // Solo mostrar categorías disponibles según la técnica y alcance seleccionados
                if (availableCategories.includes(parseInt(categoryId)) && categorizedFindings[categoryId].length > 0) {
                    const category = anatomicalCategories.find(cat => cat.id === parseInt(categoryId));
                    
                    if (category) {
                        const categoryDiv = document.createElement('div');
                        categoryDiv.className = 'category';
                        
                        let findingsHtml = '';
                        
                        // Generar HTML para cada hallazgo, añadiendo controles para reasignar si es "Otros hallazgos"
                        for (const finding of categorizedFindings[categoryId]) {
                            if (parseInt(categoryId) === 13) {
                                // Para "Otros hallazgos", mostrar selector para reasignar
                                findingsHtml += `
                                    <li class="finding-item">
                                        <div class="finding-text">${finding}</div>
                                        <div class="finding-controls">
                                            <select class="category-reassign" data-finding="${finding}">
                                                <option value="">Reasignar a...</option>
                                                ${anatomicalCategories.filter(cat => cat.id !== 13).map(cat => 
                                                    `<option value="${cat.id}">${cat.name}</option>`
                                                ).join('')}
                                            </select>
                                        </div>
                                    </li>
                                `;
                            } else {
                                findingsHtml += `<li>${finding}</li>`;
                            }
                        }
                        
                        categoryDiv.innerHTML = `
                            <h3>${category.name}</h3>
                            <div class="category-content">
                                <ul>${findingsHtml}</ul>
                            </div>
                        `;
                        
                        categorizedContent.appendChild(categoryDiv);
                    }
                }
            }
            
            // Añadir listeners para los selectores de reasignación
            document.querySelectorAll('.category-reassign').forEach(select => {
                select.addEventListener('change', (e) => {
                    const finding = e.target.dataset.finding;
                    const newCategoryId = e.target.value;
                    
                    if (newCategoryId) {
                        // Enseñar a la app dónde ubicar este hallazgo
                        teachFindingCategorization(finding, newCategoryId);
                        
                        // Mover el hallazgo a la nueva categoría
                        if (!categorizedFindings[newCategoryId]) {
                            categorizedFindings[newCategoryId] = [];
                        }
                        
                        // Añadir a la nueva categoría
                        categorizedFindings[newCategoryId].push(finding);
                        
                        // Quitar de "Otros hallazgos"
                        categorizedFindings[13] = categorizedFindings[13].filter(f => f !== finding);
                        
                        // Si "Otros hallazgos" queda vacío, eliminar la categoría
                        if (categorizedFindings[13].length === 0) {
                            delete categorizedFindings[13];
                        }
                        
                        // Actualizar la visualización
                        displayCategorizedFindings();
                    }
                });
            });
        }

        // Definición de categorías por región
        const thoracicCategories = [0, 1, 2, 3, 4]; // IDs de categorías torácicas, añadido tiroides (0)
        const abdominalCategories = [5, 6, 7, 8, 9, 10, 11, 12]; // IDs de categorías abdominales
        const otherCategories = [13]; // Categoría "Otros hallazgos"

        // Función para actualizar las categorías disponibles
        function updateAvailableCategories() {
            const imagingTechniqueSelect = document.getElementById('imaging-technique');
            const tacScopeSelect = document.getElementById('tac-scope');
            const rmTypeContainer = document.getElementById('rm-type-container');
            const tacScopeContainer = document.getElementById('tac-scope-container');
            const contrastContainer = document.getElementById('contrast-container');
            const phaseContainer = document.getElementById('phase-container');
            
            const technique = imagingTechniqueSelect.value;
            const tacScope = tacScopeSelect.value;
            
            // Mostrar/ocultar contenedores según la técnica
            if (technique === 'tac') {
                tacScopeContainer.style.display = 'flex';
                rmTypeContainer.style.display = 'none';
                contrastContainer.style.display = 'flex';
                
                if (tacScope === 'toracoabdominal') {
                    window.availableCategories = [...thoracicCategories, ...abdominalCategories, ...otherCategories];
                } else if (tacScope === 'torax') {
                    window.availableCategories = [...thoracicCategories, ...otherCategories];
                } else if (tacScope === 'abdomen') {
                    window.availableCategories = [...abdominalCategories, ...otherCategories];
                }
            } else if (technique === 'rm') {
                tacScopeContainer.style.display = 'none';
                rmTypeContainer.style.display = 'flex';
                contrastContainer.style.display = 'none';
                phaseContainer.style.display = 'none';
                window.availableCategories = [...abdominalCategories, ...otherCategories];
            } else {
                // eco
                tacScopeContainer.style.display = 'none';
                rmTypeContainer.style.display = 'none';
                contrastContainer.style.display = 'none';
                phaseContainer.style.display = 'none';
                window.availableCategories = [...abdominalCategories, ...otherCategories];
            }
            
            // Limpiar hallazgos previos
            const categorizedContent = document.getElementById('categorized-content');
            categorizedContent.innerHTML = '';
            categorizedFindings = {};
            
            // Actualizar técnica
            updateTechniqueDescription();
        }

        // Función para mostrar/ocultar opciones de fase según contraste
        function updateContrastOptions() {
            const imagingTechniqueSelect = document.getElementById('imaging-technique');
            const contrastUseSelect = document.getElementById('contrast-use');
            const phaseContainer = document.getElementById('phase-container');
            
            const technique = imagingTechniqueSelect.value;
            const contrastUse = contrastUseSelect.value;
            
            if (technique === 'tac' && contrastUse === 'con') {
                phaseContainer.style.display = 'flex';
            } else {
                phaseContainer.style.display = 'none';
                // Desmarcar checkboxes
                document.querySelectorAll('input[name="phase"]').forEach(checkbox => {
                    checkbox.checked = false;
                });
            }
            
            // Actualizar técnica
            updateTechniqueDescription();
        }

        // Función para generar y actualizar descripción de técnica
        function updateTechniqueDescription() {
            const imagingTechniqueSelect = document.getElementById('imaging-technique');
            const tacScopeSelect = document.getElementById('tac-scope');
            const rmTypeSelect = document.getElementById('rm-type');
            const contrastUseSelect = document.getElementById('contrast-use');
            const techniqueText = document.getElementById('technique-text');
            const techniqueDescription = document.getElementById('technique-description');
            
            const technique = imagingTechniqueSelect.value;
            
            // Ocultar descripción para técnicas no TAC o RM
            if (technique !== 'tac' && technique !== 'rm') {
                techniqueDescription.style.display = 'none';
                return;
            }
            
            techniqueDescription.style.display = 'block';
            
            if (technique === 'tac') {
                const tacScope = tacScopeSelect.value;
                const contrastUse = contrastUseSelect.value;
                
                let scopeText = '';
                switch(tacScope) {
                    case 'toracoabdominal': scopeText = 'toracoabdominal'; break;
                    case 'torax': scopeText = 'torácica'; break;
                    case 'abdomen': scopeText = 'abdominal'; break;
                }
                
                let contrastText = contrastUse === 'con' ? 'tras la' : 'sin la';
                
                let description = `Se realiza exploración TAC ${scopeText} ${contrastText} administración de contraste endovenoso`;
                
                // Añadir fase si hay contraste
                if (contrastUse === 'con') {
                    const checkedPhases = Array.from(document.querySelectorAll('input[name="phase"]:checked'))
                        .map(checkbox => checkbox.value);
                    
                    if (checkedPhases.length > 0) {
                        let phaseText = '';
                        
                        if (checkedPhases.length === 1) {
                            phaseText = checkedPhases[0] === 'arterial' ? 'arterial' : 
                                        checkedPhases[0] === 'portal' ? 'portal' : 'tardía';
                        } else if (checkedPhases.length === 2) {
                            const phases = checkedPhases.map(phase => {
                                return phase === 'arterial' ? 'arterial' : 
                                       phase === 'portal' ? 'portal' : 'tardía';
                            });
                            phaseText = `${phases[0]} y ${phases[1]}`;
                        } else if (checkedPhases.length === 3) {
                            phaseText = 'arterial, portal y tardía';
                        }
                        
                        description += ` con adquisición de imágenes en fase ${phaseText}`;
                    }
                }
                
                techniqueText.textContent = description + '.';
            } else if (technique === 'rm') {
                const rmType = rmTypeSelect.value;
                let description = '';
                
                switch(rmType) {
                    case 'hepatica':
                        description = 'Se realiza estudio de RM hepática con secuencias ponderadas en T1, T2, difusión y posterior a la administración de contraste hepatoespecífico.';
                        break;
                    case 'colangio':
                        description = 'Se realiza estudio de ColangioRM con secuencias ponderadas en T2 y secuencias MRCP (colangiopancreatografía por resonancia magnética).';
                        break;
                    case 'pelvis-neo':
                        description = 'Se realiza estudio de RM pélvica para valoración de neoplasia con secuencias ponderadas en T1, T2, difusión y posterior a la administración de contraste intravenoso.';
                        break;
                    case 'pelvis-fist':
                        description = 'Se realiza estudio de RM pélvica para valoración de fístulas perianales con secuencias ponderadas en T1, T2, STIR y posterior a la administración de contraste intravenoso.';
                        break;
                    case 'entero':
                        description = 'Se realiza estudio de EnteroRM con secuencias ponderadas en T1, T2, difusión y posterior a la administración de contraste intravenoso tras la adecuada distensión de asas intestinales mediante contraste oral.';
                        break;
                }
                
                techniqueText.textContent = description;
            }
        }

        /*********************
         * EVENT LISTENERS
         *********************/
        document.addEventListener('DOMContentLoaded', () => {
            // Elementos DOM
            const microphoneBtn = document.getElementById('microphone-btn');
            transcriptArea = document.getElementById('transcript'); // Assign to global
            const categorizeBtn = document.getElementById('categorize-btn');
            const clearBtn = document.getElementById('clear-btn');
            const generateReportBtn = document.getElementById('generate-report-btn');
            const copyReportBtn = document.getElementById('copy-report-btn');
            const imagingTechniqueSelect = document.getElementById('imaging-technique');
            const tacScopeSelect = document.getElementById('tac-scope');
            const rmTypeSelect = document.getElementById('rm-type');
            const contrastUseSelect = document.getElementById('contrast-use');
            const techniqueDescription = document.getElementById('technique-description');
            const backToDictationBtn = document.getElementById('backToDictationBtn'); // NEW

            // Load text from index.html if available
            const inputTextFromIndex = localStorage.getItem('juanizadorInputText');
            if (inputTextFromIndex) {
                transcriptArea.value = inputTextFromIndex;
                localStorage.removeItem('juanizadorInputText'); // Clean up
            }
            
            // Inicializar reconocimiento de voz
            initSpeechRecognition();
            
            // Inicializar categorías disponibles
            updateAvailableCategories();
            
            // Inicialmente ocultar descripciones de técnica if not TAC or RM
            updateTechniqueDescription(); // Call this to set initial visibility

            // Listeners para los selectores de técnica
            imagingTechniqueSelect.addEventListener('change', updateAvailableCategories);
            tacScopeSelect.addEventListener('change', updateAvailableCategories);
            rmTypeSelect.addEventListener('change', updateTechniqueDescription);
            contrastUseSelect.addEventListener('change', updateContrastOptions);
            
            // Listener para checkboxes de fase
            document.querySelectorAll('input[name="phase"]').forEach(checkbox => {
                checkbox.addEventListener('change', updateTechniqueDescription);
            });
            
            // Configurar event listeners
            microphoneBtn.addEventListener('click', toggleRecording);
            categorizeBtn.addEventListener('click', () => categorizeFindings(window.availableCategories));
            
            clearBtn.addEventListener('click', () => {
                transcriptArea.value = '';
                document.getElementById('categorized-content').innerHTML = '';
                categorizedFindings = {};
            });
            
            generateReportBtn.addEventListener('click', generateCompleteReport);
            
            copyReportBtn.addEventListener('click', () => {
                const techniqueDescText = document.getElementById('technique-text').textContent;
                const reportText = document.getElementById('final-report').textContent;
                let fullText = "";
                if (techniqueDescText.trim() && techniqueDescription.style.display !== 'none') {
                    fullText += techniqueDescText + "\n\n";
                }
                fullText += reportText;
                navigator.clipboard.writeText(fullText)
                    .then(() => alert('Informe copiado al portapapeles'))
                    .catch(err => console.error('Error al copiar: ', err));
            });

            // Listener for "Volver a dictado" button
            if (backToDictationBtn) { 
                backToDictationBtn.addEventListener('click', () => {
                    window.location.href = 'index.html';
                });
            }
        });
    </script>
</body>
</html>
